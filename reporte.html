<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard de Ventas Avanzado</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts"></script>
  <!-- Flatpickr para selector rango fechas -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 20px;
      background: #f4f4f4;
      color: #222;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    h1 {
      text-align: center;
      margin-bottom: 6px;
      font-weight: 700;
      color: #004080;
    }
    #subtitulo {
      text-align: center;
      margin-bottom: 30px;
      font-weight: 500;
      color: #0066cc;
      font-size: 1.1rem;
      user-select: none;
      min-height: 1.5em;
    }
    #selector-fechas {
      max-width: 400px;
      margin: 0 auto 30px auto;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    #selector-fechas input {
      padding: 8px 12px;
      font-size: 1rem;
      border: 1.8px solid #007bff;
      border-radius: 6px;
      width: 180px;
      cursor: pointer;
      user-select: none;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    #selector-fechas input:focus {
      outline: none;
      border-color: #0056b3;
    }
    #btn-limpiar-fechas {
      background-color: #e0e0e0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      padding: 8px 14px;
      font-size: 0.95rem;
      color: #555;
      user-select: none;
      transition: background-color 0.3s ease;
      align-self: center;
    }
    #btn-limpiar-fechas:hover {
      background-color: #c0c0c0;
    }

    .resumen {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    .tarjeta {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      min-width: 180px;
      max-width: 240px;
      text-align: center;
      user-select: none;
      cursor: pointer;
      transition: box-shadow 0.3s ease;
      position: relative;
    }
    .tarjeta:hover {
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }
    .tarjeta.filtrado {
      box-shadow: 0 0 0 3px #007bff;
    }
    .valor {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 6px;
      color: #0059b3;
    }
    .comparativo {
      font-size: 0.9rem;
      font-weight: 600;
      color: #888;
    }
    .comparativo.positivo {
      color: #188038;
    }
    .comparativo.negativo {
      color: #d93025;
    }
    footer {
      font-size: 0.65rem;
      padding: 0.5rem 1rem;
      line-height: 1.2;
      text-align: center;
    }
    .boton-mostrar {
      text-align: center;
      margin-bottom: 30px;
    }
    .boton-mostrar button {
      padding: 12px 30px;
      font-size: 18px;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.25s ease;
      user-select: none;
    }
    .boton-mostrar button:hover {
      background-color: #0056b3;
    }
    .graficos {
      max-width: 960px;
      margin: 0 auto 60px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 30px;
    }
    .grafico {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      height: 380px;
      user-select: none;
      cursor: pointer;
      transition: box-shadow 0.3s ease;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    .grafico.filtrado {
      box-shadow: 0 0 0 3px #007bff;
    }
    .grafico .export-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #007bff;
      border: none;
      color: white;
      padding: 5px 9px;
      font-size: 12px;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      opacity: 0.8;
      transition: opacity 0.3s ease;
      z-index: 10;
    }
    .grafico .export-btn:hover {
      opacity: 1;
    }
    /* Responsive mobile */
    @media (max-width: 768px) {
      .graficos {
        display: flex;
        flex-direction: column;
        gap: 30px;
      }
      .tarjeta {
        max-width: 100%;
        min-width: auto;
      }
      #selector-fechas {
        max-width: 100%;
        justify-content: center;
      }
      #selector-fechas input {
        width: 45vw;
        max-width: 200px;
      }
    }
  </style>
</head>
<body>
  <h1>Dashboard de Ventas Avanzado</h1>
  <div id="subtitulo">Ventas generales</div>

  <div id="selector-fechas" aria-label="Selector de rango de fechas">
    <input id="fecha-inicio" placeholder="Fecha inicio" readonly />
    <input id="fecha-fin" placeholder="Fecha fin" readonly />
    <button id="btn-limpiar-fechas" aria-label="Limpiar filtro de fechas">Limpiar</button>
  </div>

  <section aria-label="Indicadores clave de desempeÃ±o" class="resumen" id="resumen-tarjetas">
    <div class="tarjeta" id="tarjeta-total-cantidad" title="Filtrar por Ãºltimo dÃ­a (Total productos vendidos)" role="button" tabindex="0" aria-pressed="false">
      <h3>Total Productos Vendidos</h3>
      <div class="valor" id="total-cantidad">0</div>
      <div class="comparativo" id="comp-cantidad"></div>
    </div>
    <div class="tarjeta" id="tarjeta-total-ingresos" title="Filtrar por Ãºltimo dÃ­a (Total ingresos)" role="button" tabindex="0" aria-pressed="false">
      <h3>Total Ingresos</h3>
      <div class="valor" id="total-dinero">$0.00</div>
      <div class="comparativo" id="comp-ingresos"></div>
    </div>
    <div class="tarjeta" id="tarjeta-tendencia-producto" title="Filtrar por producto en tendencia" role="button" tabindex="0" aria-pressed="false">
      <h3>Producto en Tendencia â†‘</h3>
      <div class="valor" id="producto-tendencia">-</div>
      <div class="comparativo" id="comp-producto-tendencia"></div>
    </div>
  </section>

  <div class="boton-mostrar">
    <button id="btn-mostrar-todo">Mostrar todo</button>
  </div>

  <section aria-label="Panel de grÃ¡ficos de ventas" class="graficos" id="panel-graficos">
    <div id="chart-linea" class="grafico" title="Ingresos por DÃ­a" tabindex="0" aria-label="GrÃ¡fico lÃ­nea de ingresos por dÃ­a">
      <button class="export-btn" aria-label="Exportar grÃ¡fico ingresos por dÃ­a a PNG">ðŸ“·</button>
    </div>
    <div id="chart-barras" class="grafico" title="Productos MÃ¡s Vendidos" tabindex="0" aria-label="GrÃ¡fico barras productos mÃ¡s vendidos">
      <button class="export-btn" aria-label="Exportar grÃ¡fico productos mÃ¡s vendidos a PNG">ðŸ“·</button>
    </div>
    <div id="chart-tendencia" class="grafico" title="Tendencia Acumulada" tabindex="0" aria-label="GrÃ¡fico lÃ­nea tendencia acumulada">
      <button class="export-btn" aria-label="Exportar grÃ¡fico tendencia acumulada a PNG">ðŸ“·</button>
    </div>
    <div id="chart-heatmap" class="grafico" title="Ventas por DÃ­a de la Semana" tabindex="0" aria-label="GrÃ¡fico barras ventas por dÃ­a de la semana">
      <button class="export-btn" aria-label="Exportar grÃ¡fico ventas por dÃ­a de la semana a PNG">ðŸ“·</button>
    </div>
    <div id="chart-donut" class="grafico" title="DistribuciÃ³n Ingresos por Producto" tabindex="0" aria-label="GrÃ¡fico donut distribuciÃ³n ingresos por producto">
      <button class="export-btn" aria-label="Exportar grÃ¡fico donut a PNG">ðŸ“·</button>
    </div>
    <div id="chart-bullet" class="grafico" title="Bullet Chart Rendimiento Ingresos" tabindex="0" aria-label="GrÃ¡fico bullet chart rendimiento ingresos">
      <button class="export-btn" aria-label="Exportar grÃ¡fico bullet chart a PNG">ðŸ“·</button>
    </div>
    <div id="chart-treemap" class="grafico" title="Treemap Ventas por Producto" tabindex="0" aria-label="GrÃ¡fico treemap ventas por producto">
      <button class="export-btn" aria-label="Exportar grÃ¡fico treemap a PNG">ðŸ“·</button>
    </div>
    <div id="chart-slope" class="grafico" title="Slope Chart Crecimiento Productos" tabindex="0" aria-label="GrÃ¡fico slope chart crecimiento productos">
      <button class="export-btn" aria-label="Exportar grÃ¡fico slope chart a PNG">ðŸ“·</button>
    </div>
  </section>

  <footer>
    <p>&copy; 2025. Irvin Prado. Ascende Superious - Busca Cosas Superiores.</p>
  </footer>

  <script>
    const { createClient } = supabase;
    const supabaseClient = createClient(
      'https://akqttyqqfkspfvnbfcox.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrcXR0eXFxZmtzcGZ2bmJmY294Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDk1MDAsImV4cCI6MjA3MDA4NTUwMH0.9MLYC25EGp25YFkdwOqN-gdgu3k_JBCDW6y6qKtSy6k'
    );

    let datosOriginales = [];
    let filtroActivo = null; // { tipo: 'fecha'|'producto'|'rangoFecha', valor: any }
    let charts = {};
    const diasSemanaNombres = ['Dom','Lun','Mar','Mie','Jue','Vie','Sab'];

    // Formatear fecha a DD/MM/YYYY
    function formatearFecha(dateObj) {
      const d = dateObj.getDate().toString().padStart(2,'0');
      const m = (dateObj.getMonth()+1).toString().padStart(2,'0');
      const y = dateObj.getFullYear();
      return `${d}/${m}/${y}`;
    }

    // Inicializar flatpickr para selector fechas
    let fechaInicioPicker, fechaFinPicker;
    function inicializarSelectorFechas(fechaMinima, fechaMaxima) {
      fechaInicioPicker = flatpickr("#fecha-inicio", {
        dateFormat: "Y-m-d",
        maxDate: fechaMaxima,
        minDate: fechaMinima,
        defaultDate: null,
        onChange: onRangoFechasChange
      });
      fechaFinPicker = flatpickr("#fecha-fin", {
        dateFormat: "Y-m-d",
        maxDate: fechaMaxima,
        minDate: fechaMinima,
        defaultDate: null,
        onChange: onRangoFechasChange
      });
    }

    function onRangoFechasChange() {
      const inicio = fechaInicioPicker.selectedDates[0];
      const fin = fechaFinPicker.selectedDates[0];
      if (inicio && fin) {
        if (fin < inicio) {
          alert("La fecha fin no puede ser anterior a la fecha inicio.");
          return;
        }
        filtroActivo = { tipo: 'rangoFecha', valor: { inicio, fin } };
        const datosFiltrados = filtrarDatos(datosOriginales, filtroActivo);
        if (datosFiltrados.length === 0) {
          const fechasOrdenadas = [...new Set(datosOriginales.map(d => d.fechaKey))].sort();
          const fechaMasAntigua = fechasOrdenadas[0].split('-').reverse().join('/');
          alert(`No hay datos en ese rango. Fecha mÃ¡s antigua registrada: ${fechaMasAntigua}`);
          return;
        }
        actualizarSubtitulo(inicio, fin);
        actualizarTarjetas(datosFiltrados);
        actualizarGraficos(datosFiltrados);
        marcarGraficoFiltrado(null);
      }
    }

    document.getElementById('btn-limpiar-fechas').addEventListener('click', () => {
      filtroActivo = null;
      fechaInicioPicker.clear();
      fechaFinPicker.clear();
      actualizarSubtitulo();
      actualizarTarjetas(datosOriginales);
      actualizarGraficos(datosOriginales);
      marcarGraficoFiltrado(null);
    });

    function actualizarSubtitulo(inicio=null, fin=null) {
      const subtituloEl = document.getElementById('subtitulo');
      if (inicio && fin) {
        subtituloEl.textContent = `Ventas desde ${formatearFecha(inicio)} hasta ${formatearFecha(fin)}`;
      } else {
        subtituloEl.textContent = "Ventas generales";
      }
    }

    // Carga datos de Supabase y los normaliza
    async function cargarDatos() {
      try {
        const { data: ventas, error: errorVentas } = await supabaseClient
          .from('ventas')
          .select('producto_id, cantidad, fecha');
        if (errorVentas) throw errorVentas;

        const { data: productos, error: errorProductos } = await supabaseClient
          .from('Producto')
          .select('id, Producto, Precio');
        if (errorProductos) throw errorProductos;

        const mapaProductos = {};
        productos.forEach(p => {
          mapaProductos[p.id] = { nombre: p.Producto, precio: p.Precio };
        });

        const ventasEnriquecidas = ventas.map(v => {
          const prod = mapaProductos[v.producto_id];
          const fechaKey = v.fecha; // YYYY-MM-DD
          const diaSemana = new Date(fechaKey).getDay();

          return {
            ...v,
            nombre: prod ? prod.nombre : 'Desconocido',
            precio: prod ? prod.precio : 0,
            fechaKey,
            diaSemana
          };
        });
        return ventasEnriquecidas;
      } catch (err) {
        console.error("Error al cargar datos:", err);
        alert("Error al cargar datos, revisa consola.");
        return [];
      }
    }

    // Filtra segÃºn filtro activo
    function filtrarDatos(data, filtro) {
      if (!filtro) return data;
      if (filtro.tipo === 'rangoFecha') {
        const inicio = filtro.valor.inicio;
        const fin = filtro.valor.fin;
        return data.filter(d => {
          const fechaD = new Date(d.fechaKey + 'T00:00:00');
          return fechaD >= inicio && fechaD <= fin;
        });
      }
      if (filtro.tipo === 'producto') {
        return data.filter(d => d.nombre === filtro.valor);
      }
      if (filtro.tipo === 'diaSemana') {
        return data.filter(d => d.diaSemana === filtro.valor);
      }
      return data;
    }

    // Actualiza las tarjetas resumen
    function actualizarTarjetas(data) {
      const totalCantidad = data.reduce((a,v) => a+v.cantidad, 0);
      const totalIngresos = data.reduce((a,v) => a+v.cantidad*v.precio, 0);

      // Comparativos Ãºltimos dos dÃ­as
      const porFecha = {};
      data.forEach(d => {
        if (!porFecha[d.fechaKey]) porFecha[d.fechaKey] = { cantidad:0, ingresos:0 };
        porFecha[d.fechaKey].cantidad += d.cantidad;
        porFecha[d.fechaKey].ingresos += d.cantidad*d.precio;
      });
      const fechasOrdenadas = Object.keys(porFecha).sort();
      const ultimoDia = fechasOrdenadas[fechasOrdenadas.length -1];
      const diaAnterior = fechasOrdenadas[fechasOrdenadas.length -2];

      const ultCant = ultimoDia ? porFecha[ultimoDia].cantidad : 0;
      const antCant = diaAnterior ? porFecha[diaAnterior].cantidad : 0;
      const ultIng = ultimoDia ? porFecha[ultimoDia].ingresos : 0;
      const antIng = diaAnterior ? porFecha[diaAnterior].ingresos : 0;

      const compCantidad = antCant === 0 ? null : ((ultCant - antCant)/antCant)*100;
      const compIngresos = antIng === 0 ? null : ((ultIng - antIng)/antIng)*100;

      // Producto en tendencia: el que mÃ¡s creciÃ³ Ãºltimos 2 dÃ­as
      const ventasPorProducto = {};
      data.forEach(d => {
        if (!ventasPorProducto[d.nombre]) ventasPorProducto[d.nombre] = {};
        if (!ventasPorProducto[d.nombre][d.fechaKey]) ventasPorProducto[d.nombre][d.fechaKey] = 0;
        ventasPorProducto[d.nombre][d.fechaKey] += d.cantidad;
      });
      let productoTendencia = "-";
      let mayorCrecimiento = -Infinity;
      for (const producto in ventasPorProducto) {
        const fechasProd = Object.keys(ventasPorProducto[producto]).sort();
        const ult = fechasProd[fechasProd.length -1];
        const penult = fechasProd[fechasProd.length -2];
        if (ult && penult) {
          const dif = ventasPorProducto[producto][ult] - ventasPorProducto[producto][penult];
          if (dif > mayorCrecimiento) {
            mayorCrecimiento = dif;
            productoTendencia = producto;
          }
        }
      }

      // Actualizar HTML
      document.getElementById('total-cantidad').textContent = totalCantidad.toLocaleString();
      const compCantEl = document.getElementById('comp-cantidad');
      if (compCantidad === null) compCantEl.textContent = "";
      else {
        compCantEl.textContent = `${compCantidad.toFixed(1)}% vs dÃ­a anterior`;
        compCantEl.className = 'comparativo ' + (compCantidad>=0 ? 'positivo':'negativo');
      }

      document.getElementById('total-dinero').textContent = `$${totalIngresos.toFixed(2)}`;
      const compIngEl = document.getElementById('comp-ingresos');
      if (compIngresos === null) compIngEl.textContent = "";
      else {
        compIngEl.textContent = `${compIngresos.toFixed(1)}% vs dÃ­a anterior`;
        compIngEl.className = 'comparativo ' + (compIngresos>=0 ? 'positivo':'negativo');
      }

      document.getElementById('producto-tendencia').textContent = productoTendencia;
      document.getElementById('comp-producto-tendencia').textContent = mayorCrecimiento > 0 ? `+${mayorCrecimiento.toLocaleString()} unidades` : "Sin crecimiento";
      document.getElementById('comp-producto-tendencia').className = 'comparativo ' + (mayorCrecimiento>0 ? 'positivo' : 'negativo');
    }

    // Crear grÃ¡ficos con ECharts y llenarlos segÃºn datos filtrados
    function actualizarGraficos(data) {
      // Datos auxiliares
      const ingresosPorDia = {};
      const cantidadPorProducto = {};
      const ventasPorDiaSemana = [0,0,0,0,0,0,0];
      const ingresosPorProducto = {};

      data.forEach(d => {
        ingresosPorDia[d.fechaKey] = (ingresosPorDia[d.fechaKey]||0) + d.cantidad*d.precio;
        cantidadPorProducto[d.nombre] = (cantidadPorProducto[d.nombre]||0) + d.cantidad;
        ventasPorDiaSemana[d.diaSemana] += d.cantidad;
        ingresosPorProducto[d.nombre] = (ingresosPorProducto[d.nombre]||0) + d.cantidad*d.precio;
      });

      // Ordenar fechas
      const fechasOrdenadas = Object.keys(ingresosPorDia).sort();

      // Chart lÃ­nea ingresos por dÃ­a
      const optionLinea = {
        title: { text: 'Ingresos por DÃ­a', left: 'center' },
        tooltip: { trigger: 'axis', formatter: params => `${params[0].axisValue}<br/>Ingresos: $${params[0].data.toFixed(2)}` },
        xAxis: { type: 'category', data: fechasOrdenadas, axisLabel: { rotate: 45 } },
        yAxis: { type: 'value', axisLabel: { formatter: val => `$${val}` } },
        series: [{
          data: fechasOrdenadas.map(f => ingresosPorDia[f]),
          type: 'line',
          smooth: true,
          lineStyle: { color: '#007bff' },
          areaStyle: { color: 'rgba(0,123,255,0.2)' }
        }]
      };
      charts.linea.setOption(optionLinea);

      // Chart barras productos mÃ¡s vendidos
      const productosOrdenados = Object.keys(cantidadPorProducto).sort((a,b) => cantidadPorProducto[b]-cantidadPorProducto[a]).slice(0,10);
      const optionBarras = {
        title: { text: 'Productos MÃ¡s Vendidos', left: 'center' },
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        xAxis: { type: 'category', data: productosOrdenados, axisLabel: { rotate: 30, interval:0 } },
        yAxis: { type: 'value', name: 'Cantidad' },
        series: [{
          data: productosOrdenados.map(p => cantidadPorProducto[p]),
          type: 'bar',
          itemStyle: { color: '#28a745' }
        }]
      };
      charts.barras.setOption(optionBarras);

      // Chart tendencia acumulada ingresos (linea acumulativa)
      let acumulado = 0;
      const acumulados = fechasOrdenadas.map(f => acumulado += ingresosPorDia[f]);
      const optionTendencia = {
        title: { text: 'Tendencia Acumulada', left: 'center' },
        tooltip: { trigger: 'axis', formatter: params => `${params[0].axisValue}<br/>Acumulado: $${params[0].data.toFixed(2)}` },
        xAxis: { type: 'category', data: fechasOrdenadas, axisLabel: { rotate: 45 } },
        yAxis: { type: 'value', axisLabel: { formatter: val => `$${val}` } },
        series: [{
          data: acumulados,
          type: 'line',
          smooth: true,
          lineStyle: { color: '#fd7e14' },
          areaStyle: { color: 'rgba(253,126,20,0.2)' }
        }]
      };
      charts.tendencia.setOption(optionTendencia);

      // Chart heatmap ventas por dÃ­a semana (barras)
      const optionHeatmap = {
        title: { text: 'Ventas por DÃ­a de la Semana', left: 'center' },
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        xAxis: { type: 'category', data: diasSemanaNombres },
        yAxis: { type: 'value', name: 'Cantidad' },
        series: [{
          data: ventasPorDiaSemana,
          type: 'bar',
          itemStyle: { color: '#6610f2' }
        }]
      };
      charts.heatmap.setOption(optionHeatmap);

      // Chart donut distribuciÃ³n ingresos por producto
      const ingresosTotales = Object.values(ingresosPorProducto).reduce((a,b)=>a+b,0);
      const datosDonut = Object.entries(ingresosPorProducto)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,10)
        .map(([nombre, ingreso]) => ({ value: ingreso, name: nombre }));
      const optionDonut = {
        title: { text: 'DistribuciÃ³n Ingresos por Producto', left: 'center' },
        tooltip: { trigger: 'item', formatter: '{b}: ${c} ({d}%)' },
        legend: { bottom: 10, type: 'scroll' },
        series: [
          {
            name: 'Ingresos',
            type: 'pie',
            radius: ['40%', '70%'],
            avoidLabelOverlap: false,
            label: { show: false, position: 'center' },
            emphasis: { label: { show: true, fontSize: '18', fontWeight: 'bold' } },
            labelLine: { show: false },
            data: datosDonut
          }
        ]
      };
      charts.donut.setOption(optionDonut);

      // Chart bullet (rendimiento ingresos)
      // SuposiciÃ³n simple: Target diario fijo $5000, datos actuales promedio ingresos diarios
      const ingresosPorDiaArr = Object.values(ingresosPorDia);
      const avgIngresosDia = ingresosPorDiaArr.length ? ingresosPorDiaArr.reduce((a,b)=>a+b,0)/ingresosPorDiaArr.length : 0;
      const targetDiario = 5000;
      const optionBullet = {
        title: { text: 'Bullet Chart Rendimiento Ingresos', left: 'center' },
        tooltip: { formatter: params => `Ingresos: $${params.value}` },
        xAxis: { max: targetDiario * 2, splitLine: { show: false } },
        yAxis: { type: 'category', data: ['Ingresos'], axisTick: { show: false }, axisLine: { show: false }, axisLabel: { show: false } },
        series: [
          {
            type: 'bar',
            data: [targetDiario],
            itemStyle: { color: '#ddd' },
            barWidth: 20,
            barGap: '-100%',
            label: { show: true, position: 'insideRight', formatter: `Target $${targetDiario}` }
          },
          {
            type: 'bar',
            data: [avgIngresosDia],
            itemStyle: { color: '#20c997' },
            barWidth: 20,
            label: { show: true, position: 'insideRight', formatter: `Actual $${avgIngresosDia.toFixed(2)}` }
          }
        ]
      };
      charts.bullet.setOption(optionBullet);

      // Chart treemap ventas por producto (cantidad)
      const datosTreemap = Object.entries(cantidadPorProducto)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,20)
        .map(([nombre, cantidad]) => ({ name: nombre, value: cantidad }));
      const optionTreemap = {
        title: { text: 'Treemap Ventas por Producto', left: 'center' },
        tooltip: { formatter: '{b}: {c} unidades' },
        series: [{
          type: 'treemap',
          data: datosTreemap,
          leafDepth: 1,
          roam: false,
          label: { show: true, formatter: '{b}' }
        }]
      };
      charts.treemap.setOption(optionTreemap);

      // Chart slope chart crecimiento productos (Ãºltimos dos dÃ­as)
      // Preparar datos para slope chart
      const fechasDistintas = [...new Set(data.map(d => d.fechaKey))].sort();
      if (fechasDistintas.length < 2) {
        charts.slope.clear();
      } else {
        const dia1 = fechasDistintas[fechasDistintas.length - 2];
        const dia2 = fechasDistintas[fechasDistintas.length - 1];
        const ventasDia1 = {};
        const ventasDia2 = {};
        data.forEach(d => {
          if (d.fechaKey === dia1) ventasDia1[d.nombre] = (ventasDia1[d.nombre]||0) + d.cantidad;
          if (d.fechaKey === dia2) ventasDia2[d.nombre] = (ventasDia2[d.nombre]||0) + d.cantidad;
        });
        // Obtener todos productos
        const productosSlope = Array.from(new Set([...Object.keys(ventasDia1), ...Object.keys(ventasDia2)]));
        // Datos para slope chart
        // Formato: [producto, valorDia1, valorDia2]
        const datosSlope = productosSlope.map(p => [p, ventasDia1[p]||0, ventasDia2[p]||0]);
        // Opciones slope chart
        const optionSlope = {
          title: { text: 'Slope Chart Crecimiento Productos', left: 'center' },
          tooltip: {
            trigger: 'item',
            formatter: params => {
              if (params.componentType === 'series') {
                const idx = params.dataIndex;
                const item = datosSlope[idx];
                const dif = item[2] - item[1];
                return `${item[0]}<br>${dia1}: ${item[1]} unidades<br>${dia2}: ${item[2]} unidades<br>Î” ${dif > 0 ? '+' : ''}${dif}`;
              }
              return '';
            }
          },
          xAxis: {
            type: 'category',
            data: [dia1, dia2],
            axisTick: { show: false },
            axisLine: { onZero: false },
            splitLine: { show: false }
          },
          yAxis: {
            type: 'value',
            splitLine: { show: false }
          },
          series: productosSlope.map((producto, i) => ({
            type: 'line',
            data: [datosSlope[i][1], datosSlope[i][2]],
            name: producto,
            smooth: true,
            symbolSize: 8,
            lineStyle: {
              width: 2,
              color: datosSlope[i][2] >= datosSlope[i][1] ? '#198754' : '#dc3545'
            },
            emphasis: { focus: 'series' }
          })),
          legend: { show: false }
        };
        charts.slope.setOption(optionSlope);
      }
    }

    // Inicializa los grÃ¡ficos y guarda instancia en charts{}
    function inicializarGraficos() {
      charts.linea = echarts.init(document.getElementById('chart-linea'));
      charts.barras = echarts.init(document.getElementById('chart-barras'));
      charts.tendencia = echarts.init(document.getElementById('chart-tendencia'));
      charts.heatmap = echarts.init(document.getElementById('chart-heatmap'));
      charts.donut = echarts.init(document.getElementById('chart-donut'));
      charts.bullet = echarts.init(document.getElementById('chart-bullet'));
      charts.treemap = echarts.init(document.getElementById('chart-treemap'));
      charts.slope = echarts.init(document.getElementById('chart-slope'));
    }

    // Marcar grÃ¡fico filtrado (resalta)
    function marcarGraficoFiltrado(idGrafico) {
      Object.entries(charts).forEach(([key, chart]) => {
        const el = chart.getDom().parentElement;
        if (el) {
          if (key === idGrafico) el.classList.add('filtrado');
          else el.classList.remove('filtrado');
        }
      });
      // TambiÃ©n desmarcar tarjetas
      ['tarjeta-total-cantidad', 'tarjeta-total-ingresos', 'tarjeta-tendencia-producto'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if ((id === 'tarjeta-total-cantidad' && idGrafico === null) ||
            (id === 'tarjeta-total-ingresos' && idGrafico === null) ||
            (id === 'tarjeta-tendencia-producto' && idGrafico === null)) {
          el.classList.remove('filtrado');
          el.setAttribute('aria-pressed', 'false');
        }
      });
    }

    // Agregar eventos para tarjetas que filtran
    function agregarEventosTarjetas() {
      const tarjetaCantidad = document.getElementById('tarjeta-total-cantidad');
      const tarjetaIngresos = document.getElementById('tarjeta-total-ingresos');
      const tarjetaTendencia = document.getElementById('tarjeta-tendencia-producto');

      tarjetaCantidad.addEventListener('click', () => {
        filtroActivo = { tipo: 'fecha', valor: obtenerUltimaFecha(datosOriginales) };
        aplicarFiltro();
        marcarGraficoFiltrado(null);
        marcarTarjeta(tarjetaCantidad);
      });
      tarjetaIngresos.addEventListener('click', () => {
        filtroActivo = { tipo: 'fecha', valor: obtenerUltimaFecha(datosOriginales) };
        aplicarFiltro();
        marcarGraficoFiltrado(null);
        marcarTarjeta(tarjetaIngresos);
      });
      tarjetaTendencia.addEventListener('click', () => {
        const producto = document.getElementById('producto-tendencia').textContent;
        if (!producto || producto === '-') return alert('No hay producto en tendencia para filtrar.');
        filtroActivo = { tipo: 'producto', valor: producto };
        aplicarFiltro();
        marcarGraficoFiltrado(null);
        marcarTarjeta(tarjetaTendencia);
      });
    }
    function marcarTarjeta(tarjeta) {
      ['tarjeta-total-cantidad', 'tarjeta-total-ingresos', 'tarjeta-tendencia-producto'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el === tarjeta) {
          el.classList.add('filtrado');
          el.setAttribute('aria-pressed', 'true');
        } else {
          el.classList.remove('filtrado');
          el.setAttribute('aria-pressed', 'false');
        }
      });
    }
    // Obtener Ãºltima fecha en datos
    function obtenerUltimaFecha(data) {
      const fechas = [...new Set(data.map(d => d.fechaKey))].sort();
      return fechas[fechas.length - 1];
    }
    // Aplica filtro activo y actualiza todo
    function aplicarFiltro() {
      let datosFiltrados = datosOriginales;
      if (!filtroActivo) datosFiltrados = datosOriginales;
      else {
        if (filtroActivo.tipo === 'fecha') {
          datosFiltrados = datosOriginales.filter(d => d.fechaKey === filtroActivo.valor);
          actualizarSubtitulo(new Date(filtroActivo.valor + 'T00:00:00'), new Date(filtroActivo.valor + 'T00:00:00'));
        }
        else if (filtroActivo.tipo === 'producto') {
          datosFiltrados = datosOriginales.filter(d => d.nombre === filtroActivo.valor);
          actualizarSubtitulo();
        }
        else if (filtroActivo.tipo === 'rangoFecha') {
          const inicio = filtroActivo.valor.inicio;
          const fin = filtroActivo.valor.fin;
          datosFiltrados = datosOriginales.filter(d => {
            const fechaD = new Date(d.fechaKey + 'T00:00:00');
            return fechaD >= inicio && fechaD <= fin;
          });
          actualizarSubtitulo(inicio, fin);
        }
        else datosFiltrados = datosOriginales;
      }
      actualizarTarjetas(datosFiltrados);
      actualizarGraficos(datosFiltrados);
    }

    // Exportar grÃ¡fico a PNG
    function agregarExportadores() {
      Object.entries(charts).forEach(([key, chart]) => {
        const btn = chart.getDom().parentElement.querySelector('.export-btn');
        btn.addEventListener('click', e => {
          e.stopPropagation();
          const url = chart.getDataURL({ pixelRatio: 2, backgroundColor: '#fff' });
          const link = document.createElement('a');
          link.href = url;
          link.download = `grafico_${key}.png`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        });
      });
    }

    // BotÃ³n mostrar todo quita filtro y muestra todo
    document.getElementById('btn-mostrar-todo').addEventListener('click', () => {
      filtroActivo = null;
      fechaInicioPicker.clear();
      fechaFinPicker.clear();
      actualizarSubtitulo();
      actualizarTarjetas(datosOriginales);
      actualizarGraficos(datosOriginales);
      marcarGraficoFiltrado(null);
      marcarTarjeta(null);
    });

    // InicializaciÃ³n principal
    async function inicializar() {
      inicializarSelectorFechas('2022-01-01', new Date());
      inicializarGraficos();
      datosOriginales = await cargarDatos();
      if (datosOriginales.length === 0) {
        alert("No hay datos disponibles.");
        return;
      }
      actualizarTarjetas(datosOriginales);
      actualizarGraficos(datosOriginales);
      agregarEventosTarjetas();
      agregarExportadores();
    }

    window.addEventListener('load', inicializar);
    window.addEventListener('resize', () => {
      Object.values(charts).forEach(c => c.resize());
    });
  </script>
</body>
</html>
