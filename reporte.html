<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard de Ventas Avanzado</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 20px;
      background: #f4f4f4;
      color: #222;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-weight: 700;
      color: #004080;
    }
    .resumen {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    .tarjeta {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      min-width: 180px;
      max-width: 240px;
      text-align: center;
      user-select: none;
      cursor: pointer;
      transition: box-shadow 0.3s ease;
      position: relative;
    }
    .tarjeta:hover {
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }
    .tarjeta.filtrado {
      box-shadow: 0 0 0 3px #007bff;
    }
    .valor {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 6px;
      color: #0059b3;
    }
    .comparativo {
      font-size: 0.9rem;
      font-weight: 600;
      color: #888;
    }
    .comparativo.positivo {
      color: #188038;
    }
    .comparativo.negativo {
      color: #d93025;
    }
    footer {
      font-size: 0.65rem;
      padding: 0.5rem 1rem;
      line-height: 1.2;
      text-align: center;
    }
    .boton-mostrar {
      text-align: center;
      margin-bottom: 30px;
    }
    .boton-mostrar button {
      padding: 12px 30px;
      font-size: 18px;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.25s ease;
      user-select: none;
    }
    .boton-mostrar button:hover {
      background-color: #0056b3;
    }
    .graficos {
      max-width: 960px;
      margin: 0 auto 60px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 30px;
    }
    .grafico {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      height: 380px;
      user-select: none;
      cursor: pointer;
      transition: box-shadow 0.3s ease;
      position: relative;
    }
    .grafico.filtrado {
      box-shadow: 0 0 0 3px #007bff;
    }
    /* Responsive mobile */
    @media (max-width: 768px) {
      .graficos {
        display: flex;
        flex-direction: column;
        gap: 30px;
      }
      .tarjeta {
        max-width: 100%;
        min-width: auto;
      }
    }
  </style>
</head>
<body>
  <h1>Dashboard de Ventas Avanzado</h1>

  <div class="resumen" id="resumen-tarjetas">
    <div class="tarjeta" id="tarjeta-total-cantidad" title="Filtrar por último día (Total productos vendidos)">
      <h3>Total Productos Vendidos</h3>
      <div class="valor" id="total-cantidad">0</div>
      <div class="comparativo" id="comp-cantidad"></div>
    </div>
    <div class="tarjeta" id="tarjeta-total-ingresos" title="Filtrar por último día (Total ingresos)">
      <h3>Total Ingresos</h3>
      <div class="valor" id="total-dinero">$0.00</div>
      <div class="comparativo" id="comp-ingresos"></div>
    </div>
    <div class="tarjeta" id="tarjeta-tendencia-producto" title="Filtrar por producto en tendencia">
      <h3>Producto en Tendencia ↑</h3>
      <div class="valor" id="producto-tendencia">-</div>
      <div class="comparativo" id="comp-producto-tendencia"></div>
    </div>
  </div>

  <div class="boton-mostrar">
    <button id="btn-mostrar-todo">Mostrar todo</button>
  </div>

  <div class="graficos">
    <div id="chart-linea" class="grafico" title="Ingresos por Día"></div>
    <div id="chart-barras" class="grafico" title="Productos Más Vendidos"></div>
    <div id="chart-tendencia" class="grafico" title="Tendencia Acumulada"></div>
    <div id="chart-heatmap" class="grafico" title="Ventas por Día de la Semana"></div>
  </div>
  <footer>
    <p>&copy; 2025. Irvin Prado. Ascende Superious - Busca Cosas Superiores.</p>
  </footer>
  <script>
    const { createClient } = supabase;
    const supabaseClient = createClient(
      'https://akqttyqqfkspfvnbfcox.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrcXR0eXFxZmtzcGZ2bmJmY294Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDk1MDAsImV4cCI6MjA3MDA4NTUwMH0.9MLYC25EGp25YFkdwOqN-gdgu3k_JBCDW6y6qKtSy6k'
    );

    let datosOriginales = [];
    let filtroActivo = null; // { tipo: 'fecha'|'producto'|'diaSemana', valor: string|number }

    const diasSemanaNombres = ['Dom','Lun','Mar','Mie','Jue','Vie','Sab'];

    async function cargarDatos() {
      try {
        const { data: ventas, error: errorVentas } = await supabaseClient
          .from('ventas')
          .select('producto_id, cantidad, fecha');
        if (errorVentas) throw errorVentas;

        const { data: productos, error: errorProductos } = await supabaseClient
          .from('Producto')
          .select('id, Producto, Precio');
        if (errorProductos) throw errorProductos;

        const mapaProductos = {};
        productos.forEach(p => {
          mapaProductos[p.id] = { nombre: p.Producto, precio: p.Precio };
        });

        const ventasEnriquecidas = ventas.map(v => {
          const prod = mapaProductos[v.producto_id];
          const fechaKey = v.fecha; // YYYY-MM-DD
          const fechaFormateada = fechaKey.split('-').reverse().join('/'); // DD/MM/YYYY
          const diaSemana = new Date(fechaKey).getDay();

          return {
            ...v,
            nombre: prod ? prod.nombre : 'Desconocido',
            precio: prod ? prod.precio : 0,
            fechaKey,
            fechaFormateada,
            diaSemana
          };
        });
        return ventasEnriquecidas;
      } catch (err) {
        console.error("Error al cargar datos:", err);
        alert("Error al cargar datos, revisa consola.");
        return [];
      }
    }

    function calcularKPIs(data) {
      const porFecha = {};
      data.forEach(d => {
        if (!porFecha[d.fechaKey]) porFecha[d.fechaKey] = { cantidad: 0, ingresos: 0 };
        porFecha[d.fechaKey].cantidad += d.cantidad;
        porFecha[d.fechaKey].ingresos += d.cantidad * d.precio;
      });
      const fechasOrdenadas = Object.keys(porFecha).sort();

      const totalCantidad = data.reduce((sum,v) => sum + v.cantidad, 0);
      const totalIngresos = data.reduce((sum,v) => sum + v.cantidad*v.precio, 0);

      const ultimoDia = fechasOrdenadas[fechasOrdenadas.length - 1];
      const diaAnterior = fechasOrdenadas[fechasOrdenadas.length - 2];

      const ultCant = ultimoDia ? porFecha[ultimoDia].cantidad : 0;
      const antCant = diaAnterior ? porFecha[diaAnterior].cantidad : 0;

      const ultIngresos = ultimoDia ? porFecha[ultimoDia].ingresos : 0;
      const antIngresos = diaAnterior ? porFecha[diaAnterior].ingresos : 0;

      const compCantidad = antCant === 0 ? null : ((ultCant - antCant) / antCant) * 100;
      const compIngresos = antIngresos === 0 ? null : ((ultIngresos - antIngresos) / antIngresos) * 100;

      return {
        totalCantidad,
        totalIngresos,
        compCantidad,
        compIngresos
      };
    }

    function calcularProductoTendencia(data) {
      const ventasPorProductoFecha = {};
      data.forEach(d => {
        if (!ventasPorProductoFecha[d.nombre]) ventasPorProductoFecha[d.nombre] = {};
        if (!ventasPorProductoFecha[d.nombre][d.fechaKey]) ventasPorProductoFecha[d.nombre][d.fechaKey] = 0;
        ventasPorProductoFecha[d.nombre][d.fechaKey] += d.cantidad;
      });

      const fechas = [...new Set(data.map(d => d.fechaKey))].sort();

      if (fechas.length < 2) return { nombre: '-', crecimiento: 0 };

      const ultimo = fechas[fechas.length - 1];
      const anterior = fechas[fechas.length - 2];

      let mejorProducto = null;
      let mejorCrecimiento = -Infinity;

      Object.entries(ventasPorProductoFecha).forEach(([prod, ventasFecha]) => {
        const ultVal = ventasFecha[ultimo] || 0;
        const antVal = ventasFecha[anterior] || 0;
        if (antVal === 0 && ultVal > 0) {
          if (Infinity > mejorCrecimiento) {
            mejorProducto = prod;
            mejorCrecimiento = Infinity;
          }
        } else if (antVal > 0) {
          const crecimiento = ((ultVal - antVal) / antVal) * 100;
          if (crecimiento > mejorCrecimiento) {
            mejorProducto = prod;
            mejorCrecimiento = crecimiento;
          }
        }
      });

      if (!mejorProducto) return { nombre: '-', crecimiento: 0 };
      return { nombre: mejorProducto, crecimiento: mejorCrecimiento };
    }

    function actualizarTarjetas(data) {
      const kpis = calcularKPIs(data);
      const tendencia = calcularProductoTendencia(data);

      document.getElementById('total-cantidad').textContent = kpis.totalCantidad;
      document.getElementById('total-dinero').textContent = `$${kpis.totalIngresos.toFixed(2)}`;

      const compCantEl = document.getElementById('comp-cantidad');
      if (kpis.compCantidad === null) {
        compCantEl.textContent = '';
        compCantEl.className = 'comparativo';
      } else {
        compCantEl.textContent = (kpis.compCantidad > 0 ? '▲ ' : '▼ ') + Math.abs(kpis.compCantidad).toFixed(1) + '% vs día anterior';
        compCantEl.className = 'comparativo ' + (kpis.compCantidad > 0 ? 'positivo' : 'negativo');
      }

      const compIngEl = document.getElementById('comp-ingresos');
      if (kpis.compIngresos === null) {
        compIngEl.textContent = '';
        compIngEl.className = 'comparativo';
      } else {
        compIngEl.textContent = (kpis.compIngresos > 0 ? '▲ ' : '▼ ') + Math.abs(kpis.compIngresos).toFixed(1) + '% vs día anterior';
        compIngEl.className = 'comparativo ' + (kpis.compIngresos > 0 ? 'positivo' : 'negativo');
      }

      const prodTendEl = document.getElementById('producto-tendencia');
      prodTendEl.textContent = tendencia.nombre;

      const compProdTendEl = document.getElementById('comp-producto-tendencia');
      if (tendencia.crecimiento === Infinity) {
        compProdTendEl.textContent = 'Nuevo producto vendido';
        compProdTendEl.className = 'comparativo positivo';
      } else if (tendencia.crecimiento > 0) {
        compProdTendEl.textContent = `▲ ${tendencia.crecimiento.toFixed(1)}% crecimiento vs día anterior`;
        compProdTendEl.className = 'comparativo positivo';
      } else if (tendencia.crecimiento < 0) {
        compProdTendEl.textContent = `▼ ${Math.abs(tendencia.crecimiento).toFixed(1)}% decrecimiento`;
        compProdTendEl.className = 'comparativo negativo';
      } else {
        compProdTendEl.textContent = '-';
        compProdTendEl.className = 'comparativo';
      }

      // Marca visual para filtro activo en tarjetas resumen
      document.querySelectorAll('.tarjeta').forEach(tarjeta => {
        tarjeta.classList.remove('filtrado');
      });
      if (filtroActivo) {
        if (filtroActivo.tipo === 'producto') {
          if (filtroActivo.valor === tendencia.nombre) {
            document.getElementById('tarjeta-tendencia-producto').classList.add('filtrado');
          }
        }
        if (filtroActivo.tipo === 'fecha') {
          // Marcar tarjetas de total cantidad e ingresos (que filtran por último día)
          // Por simplicidad marcar ambas
          document.getElementById('tarjeta-total-cantidad').classList.add('filtrado');
          document.getElementById('tarjeta-total-ingresos').classList.add('filtrado');
        }
      }
    }

    let chartLinea, chartBarras, chartTendencia, chartHeatmap;

    function dibujarGraficoLinea(data) {
      const ventasPorDia = {};
      data.forEach(item => {
        ventasPorDia[item.fechaKey] = (ventasPorDia[item.fechaKey] || 0) + item.cantidad * item.precio;
      });
      const fechas = Object.keys(ventasPorDia).sort();

      const option = {
        title: { text: 'Ingresos por Día' },
        tooltip: { trigger: 'axis', formatter: params => {
          const d = params[0];
          return `${d.axisValue.split('-').reverse().join('/')}<br/>Ingresos: $${d.data.toFixed(2)}`;
        }},
        xAxis: { 
          type: 'category', 
          data: fechas, 
          axisLabel: { formatter: d => d.split('-').reverse().join('/') } 
        },
        yAxis: { type: 'value' },
        series: [{ data: fechas.map(f => ventasPorDia[f]), type: 'line', smooth: true, name: 'Ingresos' }],
        grid: { bottom: 60 },
      };
      chartLinea.setOption(option);

      // Interactividad clic en línea: filtrar por fecha
      chartLinea.off('click');
      chartLinea.on('click', params => {
        if (params.componentType === 'xAxis') return; // Ignorar click en eje
        if (params.componentType === 'series') {
          filtroActivo = { tipo: 'fecha', valor: params.name };
          const datosFiltrados = filtrarDatos(datosOriginales, filtroActivo);
          actualizarTarjetas(datosFiltrados);
          actualizarGraficos(datosFiltrados);
          marcarGraficoFiltrado(chartLinea);
        }
      });
    }

    function dibujarGraficoBarras(data) {
      const ventasPorProducto = {};
      data.forEach(item => {
        ventasPorProducto[item.nombre] = (ventasPorProducto[item.nombre] || 0) + item.cantidad;
      });
      const productos = Object.keys(ventasPorProducto);
      const cantidades = productos.map(p => ventasPorProducto[p]);

      const maxCant = Math.max(...cantidades);
      const minCant = Math.min(...cantidades);

      const colors = cantidades.map(c => c === minCant ? '#d93025' : '#5470c6');

      const option = {
        title: { text: 'Productos Más Vendidos' },
        tooltip: {},
        xAxis: {
          type: 'category',
          data: productos,
          axisLabel: { interval: 0, rotate: 30 }
        },
        yAxis: { type: 'value' },
        series: [{
          data: cantidades.map((c,i) => ({
            value: c,
            itemStyle: { color: colors[i] }
          })),
          type: 'bar',
          name: 'Cantidad',
          barMaxWidth: 50,
        }]
      };
      chartBarras.setOption(option);

      // Interactividad clic en barra: filtrar por producto
      chartBarras.off('click');
      chartBarras.on('click', params => {
        if (params.componentType === 'series') {
          filtroActivo = { tipo: 'producto', valor: params.name };
          const datosFiltrados = filtrarDatos(datosOriginales, filtroActivo);
          actualizarTarjetas(datosFiltrados);
          actualizarGraficos(datosFiltrados);
          marcarGraficoFiltrado(chartBarras);
        }
      });
    }

    function dibujarGraficoTendencia(data) {
      const fechas = [...new Set(data.map(d => d.fechaKey))].sort();
      const porDia = fechas.map(f => {
        const subset = data.filter(d => d.fechaKey === f);
        return {
          fecha: f,
          ingresos: subset.reduce((a,b) => a + b.cantidad*b.precio,0),
          cantidad: subset.reduce((a,b) => a + b.cantidad,0)
        };
      });

      let acumuladoIngresos = 0;
      let acumuladoCantidad = 0;
      const ingresosAcum = [];
      const cantidadAcum = [];

      fechas.forEach(f => {
        const obj = porDia.find(d => d.fecha === f);
        acumuladoIngresos += obj.ingresos;
        acumuladoCantidad += obj.cantidad;
        ingresosAcum.push(acumuladoIngresos);
        cantidadAcum.push(acumuladoCantidad);
      });

      const option = {
        title: { text: 'Tendencia Acumulada (Ingresos y Cantidad)' },
        tooltip: { trigger: 'axis', formatter: params => {
          const d = params[0];
          return `${d.axisValue.split('-').reverse().join('/')}<br/>Ingresos: $${params[0].data.toFixed(2)}<br/>Cantidad: ${params[1].data}`;
        }},
        legend: { data: ['Ingresos', 'Cantidad'] },
        xAxis: {
          type: 'category',
          data: fechas,
          axisLabel: { formatter: d => d.split('-').reverse().join('/'), rotate: 30, interval: 0 }
        },
        yAxis: [
          { type: 'value', name: 'Ingresos', position: 'left' },
          { type: 'value', name: 'Cantidad', position: 'right' }
        ],
        series: [
          {
            name: 'Ingresos',
            type: 'line',
            smooth: true,
            data: ingresosAcum,
            yAxisIndex: 0,
            itemStyle: { color: '#5470c6' }
          },
          {
            name: 'Cantidad',
            type: 'line',
            smooth: true,
            data: cantidadAcum,
            yAxisIndex: 1,
            itemStyle: { color: '#91cc75' }
          }
        ],
        grid: { bottom: 90 }
      };
      chartTendencia.setOption(option);

      // Interactividad clic: filtrar por fecha (sobre cualquiera de las dos series)
      chartTendencia.off('click');
      chartTendencia.on('click', params => {
        if (params.componentType === 'series' || params.componentType === 'xAxis') {
          filtroActivo = { tipo: 'fecha', valor: params.name };
          const datosFiltrados = filtrarDatos(datosOriginales, filtroActivo);
          actualizarTarjetas(datosFiltrados);
          actualizarGraficos(datosFiltrados);
          marcarGraficoFiltrado(chartTendencia);
        }
      });
    }

    function dibujarGraficoHeatmap(data) {
      // Cambiado a gráfico de barras: Ventas por Día de la Semana
      const ventasPorDiaSemana = [0,0,0,0,0,0,0];
      data.forEach(item => {
        ventasPorDiaSemana[item.diaSemana] += item.cantidad;
      });

      const option = {
        title: { text: 'Ventas por Día de la Semana (Barras)' },
        tooltip: { 
          trigger: 'axis',
          formatter: params => {
            const p = params[0];
            return `${diasSemanaNombres[p.dataIndex]}: ${p.data} productos`;
          }
        },
        xAxis: {
          type: 'category',
          data: diasSemanaNombres,
          axisLabel: { rotate: 30 }
        },
        yAxis: {
          type: 'value',
          name: 'Cantidad',
        },
        series: [{
          type: 'bar',
          data: ventasPorDiaSemana,
          itemStyle: {
            color: '#5470c6'
          },
          name: 'Cantidad de Ventas',
          barMaxWidth: 50
        }]
      };
      chartHeatmap.setOption(option);

      // Interactividad clic en barra: filtrar por día de la semana (0=Domingo..6=Sábado)
      chartHeatmap.off('click');
      chartHeatmap.on('click', params => {
        if (params.componentType === 'series') {
          filtroActivo = { tipo: 'diaSemana', valor: params.dataIndex };
          const datosFiltrados = filtrarDatos(datosOriginales, filtroActivo);
          actualizarTarjetas(datosFiltrados);
          actualizarGraficos(datosFiltrados);
          marcarGraficoFiltrado(chartHeatmap);
        }
      });
    }

    function inicializarGraficos() {
      chartLinea = echarts.init(document.getElementById('chart-linea'));
      chartBarras = echarts.init(document.getElementById('chart-barras'));
      chartTendencia = echarts.init(document.getElementById('chart-tendencia'));
      chartHeatmap = echarts.init(document.getElementById('chart-heatmap'));
    }

    function actualizarGraficos(data) {
      dibujarGraficoLinea(data);
      dibujarGraficoBarras(data);
      dibujarGraficoTendencia(data);
      dibujarGraficoHeatmap(data);

      // Marca visual en gráficos segun filtro activo
      marcarGraficoFiltrado(null); // resetea todos
    }

    function filtrarDatos(data, filtro) {
      if (!filtro) return data;
      if (filtro.tipo === 'fecha') {
        return data.filter(d => d.fechaKey === filtro.valor);
      } else if (filtro.tipo === 'producto') {
        return data.filter(d => d.nombre === filtro.valor);
      } else if (filtro.tipo === 'diaSemana') {
        return data.filter(d => d.diaSemana === filtro.valor);
      }
      return data;
    }

    function marcarGraficoFiltrado(graficoFiltrado) {
      // Remover clase filtrado de todos gráficos
      [chartLinea, chartBarras, chartTendencia, chartHeatmap].forEach(c => {
        c.getDom().classList.remove('filtrado');
      });
      if (graficoFiltrado) {
        graficoFiltrado.getDom().classList.add('filtrado');
      }
    }

    async function inicializarDashboard() {
      datosOriginales = await cargarDatos();
      inicializarGraficos();
      actualizarTarjetas(datosOriginales);
      actualizarGraficos(datosOriginales);
    }

    // Interactividad tarjetas resumen
    document.getElementById('tarjeta-tendencia-producto').addEventListener('click', () => {
      const nombreProd = document.getElementById('producto-tendencia').textContent;
      if (nombreProd && nombreProd !== '-') {
        filtroActivo = { tipo: 'producto', valor: nombreProd };
        const datosFiltrados = filtrarDatos(datosOriginales, filtroActivo);
        actualizarTarjetas(datosFiltrados);
        actualizarGraficos(datosFiltrados);
        marcarGraficoFiltrado(null);
      }
    });

    document.getElementById('tarjeta-total-cantidad').addEventListener('click', () => {
      const fechas = [...new Set(datosOriginales.map(d => d.fechaKey))].sort();
      if (fechas.length > 0) {
        filtroActivo = { tipo: 'fecha', valor: fechas[fechas.length - 1] };
        const datosFiltrados = filtrarDatos(datosOriginales, filtroActivo);
        actualizarTarjetas(datosFiltrados);
        actualizarGraficos(datosFiltrados);
        marcarGraficoFiltrado(null);
      }
    });

    document.getElementById('tarjeta-total-ingresos').addEventListener('click', () => {
      const fechas = [...new Set(datosOriginales.map(d => d.fechaKey))].sort();
      if (fechas.length > 0) {
        filtroActivo = { tipo: 'fecha', valor: fechas[fechas.length - 1] };
        const datosFiltrados = filtrarDatos(datosOriginales, filtroActivo);
        actualizarTarjetas(datosFiltrados);
        actualizarGraficos(datosFiltrados);
        marcarGraficoFiltrado(null);
      }
    });

    document.getElementById('btn-mostrar-todo').addEventListener('click', () => {
      filtroActivo = null;
      actualizarTarjetas(datosOriginales);
      actualizarGraficos(datosOriginales);
      marcarGraficoFiltrado(null);
    });

    window.onload = inicializarDashboard;
  </script>
</body>
</html>
